<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta charset="UTF-8">
            <title>Festivals</title>
            <style type="text/css">
                #map_canvas {
                    width: 800px;
                    height: 600px;
                    float: left;
                }

                #combo_div {
                    display: block;
                    margin-left: 10px;
                    width: 500px;
                    height: 100px;
                    float: left;
                }

                #genres {
                    width: 500px;
                }

                #button {
                    width: 200px;
                    float: left;
                    margin-left: 150px;
                    background: #02324A;
                    color: white;
                    border-radius: 4px;
                    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
                    clear: both;
                }

                #festivalsInfo {
                    clear: both;
                    position: relavtive;
                    float: left;
                    margin-left: 10px;
                    margin-top: 15px;
                    width: 500px;
                    overflow: hidden;
                    white-space: nowrap;
                }

                #lineup {
                    color: white;
                }
            </style>
            <script src="http://maps.google.com/maps/api/js?sensor=false"
            type="text/javascript"></script>
            <script type="text/javascript"
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
            <script type="text/javascript" src="requests.js"></script>
            <script type="text/javascript">
                function initialize(json) {
                    var festivals = new Array();
                    festivals = JSON.parse(json);
                    var map_options = {
                        center: new google.maps.LatLng(50.086161, 14.411519999999996),
                        zoom: 3,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    };

                    var google_map = new google.maps.Map(document
                            .getElementById("map_canvas"), map_options);

                    var info_window = new google.maps.InfoWindow({
                        content: 'loading'
                    });

                    var t = [];
                    var x = [];
                    var y = [];
                    var h = [];
                    var f = [];
                    var d1 = [];
                    var d2 = [];
                    var l = [];
                    for (var j = 0; j < festivals.length; j++) {
                        var lineup = [];
                        var lineupJSON = JSON.parse(JSON.stringify(festivals[j].lineup));
                        lineupJSON.forEach(function(artist) {
                            var artistWithGenres = artist.artistName.toUpperCase() + " plays:[";
                           	var genres = artist.genres;
                           	genres.forEach(function(genre){
                           		artistWithGenres += genre.genreTitle + ", ";
                           	});
                           	artistWithGenres += "]";
                        	lineup.push(artistWithGenres);
                        });
                        f.push(lineup);
                        var beginDate = festivals[j].interval.start;
                        d1.push(beginDate);
                        var endDate = festivals[j].interval.end;
                        d2.push(endDate);
                        var festivalName = festivals[j].festivalName;
                        var locationName = festivals[j].location.locationName;
                        l.push(locationName);
                        t.push(festivalName);
                        var lat = festivals[j].location.lat;
                        x.push(lat);
                        var lng = festivals[j].location.lng;
                        y.push(lng);
                        h.push('<p><strong>' + festivalName + '</strong></br>Location: '
                                + locationName + '</p>');

                    }
                    var m = [];
                    var index = 0;
                    for (var i = 0; i < t.length; i++) {
                        var pin = new google.maps.Marker({
                            map: google_map,
                            animation: google.maps.Animation.DROP,
                            title: t[i],
                            position: new google.maps.LatLng(x[i], y[i]),
                            html: h[i],
                            text: f[i],
                            begin: d1[i],
                            end: d2[i],
                            location: l[i]
                        });
                        google.maps.event.addListener(pin, 'click', function() {
                            index = i;
                            info_window.setContent(this.html);
                            info_window.open(google_map, this);
                            var div = document.getElementById('festivalInfo');
                            var h2 = document.getElementById('lineup');
                            h2.innerHTML = "";
                            h2.innerHTML = "Lineup of " + this.title;
                            h2.style.color = "#02324A";
                            div.innerHTML = "Location: " + this.location + "</br>";
                            div.innerHTML = div.innerHTML + "Starts at: " + this.begin + "</br>Ends at: "
                                    + this.end + " </br></br>";
                            this.text.forEach(function(artist) {
                                div.innerHTML = div.innerHTML + artist + "</br>";
                            });

                        });
                    }
                }
            </script>
            <script type="text/javascript">
                function getDataGenre() {
                    var json = getData("genres");
                    addItem(json);
                }
            </script>
            <script type="text/javascript">
                function addItem(json) {
                    var mostPopularGenres = ['techno', 'house', 'minimal', 'trance',
                        'indie', 'heavy metal', 'electronic', 'drum n bass', 'jazz',
                        'rap', 'hip hop', 'alternative', '80s', '90s', 'deep house',
                        'progressive', 'rock', 'punk', 'metal', 'pop', 'rnb'];
                    var genres = new Array();
                    var genresStringify = JSON.stringify(json);
                    var genres = JSON.parse(genresStringify);
                    var div = document.getElementById("genres");
                    div.innerHTML = "<h2>Select genre to load festivals: </br></h2>";
                    div.style.color = "#02324A";
                    for (var i = 0; i < genres.length; i++) {
                        for (g in mostPopularGenres) {
                            if (mostPopularGenres[g] == genres[i].title) {
                                div.innerHTML = div.innerHTML + '       ' + '<a href="#" class="genre" id="' + genres[i].title + '" onclick="getFestivalsWithGenre(id);">' +
                                        genres[i].title + '[' + genres[i].numOfFestWithGenre + "]</a>";

                            }
                        }

                    }
                }
            </script>
            <script type="text/javascript">
                function getFestivalsWithGenre(selectValue) {
                    var json = getData("festivals?genre=" + selectValue);
                    initialize(JSON.stringify(json));
                }
            </script>
            <script type="text/javascript">
                $(".genre").click(function() {
                    var value = $(this).attr("id");
                    console.log(value);
                });
            </script>
    </head>
    <body onLoad="getDataGenre()">
        <div id="container">
            <div id="map_canvas"></div>
            <div id="combo_div">
                <span id="genres"></span>
                <!--<select id="genres"></select>
                <button id="button" type="button" onClick='getFestivalsWithGenre()'>Show
                    festivals on map</button> -->
                <br><br><h2 id="lineup" color="white"></h2>
                        <span id="festivalInfo" style="color: #48A398"></span>
                        </div>



                        </div>
                        </body>
                        </html>